<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Brahmin Foods</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .toast {
      transition: all 0.3s ease;
      transform: translateY(100%);
      opacity: 0;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50">
  <header class="bg-gradient-to-r from-green-800 to-green-600 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6 text-center">
      <h1 class="text-3xl font-bold">Brahmin Foods</h1>
      <p class="mt-1 text-green-100">ఆంధ్ర బ్రాహ్మణ వంటకాలు</p>
      <p class="mt-2 opacity-90">Secure Checkout</p>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Delivery Information -->
      <section class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-bold text-green-800 border-b-2 border-green-200 pb-2 mb-6 relative">
          Delivery Information
          <span class="absolute bottom-0 left-0 h-0.5 bg-yellow-500 w-16"></span>
        </h2>
        
        <form id="delivery-form" class="space-y-4">
          <div>
            <label for="full-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
            <input type="text" id="full-name" required
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
          </div>
          
          <div>
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
            <input type="tel" id="phone" required pattern="[0-9]{10}"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                   placeholder="10-digit mobile number">
          </div>
          
          <div>
            <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
            <textarea id="address" rows="3" required
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"></textarea>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
              <input type="text" id="city" required
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
            
            <div>
              <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State</label>
              <input type="text" id="state" required
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="pincode" class="block text-sm font-medium text-gray-700 mb-1">Pin Code</label>
              <input type="text" id="pincode" required pattern="[0-9]{6}"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                     placeholder="6-digit pincode">
            </div>
            
            <div>
              <label for="landmark" class="block text-sm font-medium text-gray-700 mb-1">Landmark (Optional)</label>
              <input type="text" id="landmark"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                     placeholder="Nearby landmark">
            </div>
          </div>
          
          <div>
            <label for="delivery-type" class="block text-sm font-medium text-gray-700 mb-1">Delivery Type</label>
            <select id="delivery-type"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 appearance-none bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgaGVpZ2h0PSIxNiIgZmlsbD0iIzFlYTcxYSIgdmlld0JveD0iMCAwIDE2IDE2Ij48cGF0aCBkPSJNMTEuMDYgNy4yN2EuNzUuNzUgMCAwIDEgMS4wNiAwbDMuMjUgMy4yNWEuNzUuNzUgMCAwIDEgMCAxLjA2bC0zLjI1IDMuMjVhLjc1Ljc1IDAgMSAxLTEuMDYtMS4wNkwxMy4zMSA4bC0yLjcyLTIuNzJhLjc1Ljc1IDAgMCAxIDAtMS4wNnptLTQuNSAwYS43NS43NSAwIDAgMSAwIDEuMDZMMy44MSA4bDIuNzUgMi43NWEuNzUuNzUgMCAwIDEtMS4wNiAxLjA2TC43OCA4LjUzYS43NS43NSAwIDAgMSAwLTEuMDZsMy4yNS0zLjI1YS43NS43NSAwIDAgMSAxLjA2IDB6Ii8+PC9zdmc+')] bg-no-repeat bg-[center_right_0.75rem]">
              <option value="guntur">Within Guntur (₹40 delivery)</option>
              <option value="courier">Courier (Outside Guntur)</option>
            </select>
          </div>
          
          <div id="courier-fields" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div>
              <label for="courier-preference" class="block text-sm font-medium text-gray-700 mb-1">Courier Preference (Optional)</label>
              <input type="text" id="courier-preference"
                     class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                     placeholder="e.g., DTDC, BlueDart">
            </div>
            
            <div class="flex items-center">
              <input type="checkbox" id="agree-courier" required
                     class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
              <label for="agree-courier" class="ml-2 text-sm text-gray-700">
                I agree to pay additional courier charges
              </label>
            </div>
          </div>
        </form>
      </section>

      <!-- Order Summary -->
      <section class="bg-white rounded-xl shadow-md p-6">
        <h2 class="text-xl font-bold text-green-800 border-b-2 border-green-200 pb-2 mb-6 relative">
          Order Summary
          <span class="absolute bottom-0 left-0 h-0.5 bg-yellow-500 w-16"></span>
        </h2>
        
        <div id="order-items" class="space-y-3 mb-4">
          <!-- Order items will be loaded here -->
        </div>
        
        <div class="border-t border-gray-200 pt-4 space-y-2">
          <div class="flex justify-between">
            <span class="text-gray-600">Subtotal</span>
            <span id="order-subtotal" class="font-medium">₹0</span>
          </div>
          
          <div class="flex justify-between">
            <span class="text-gray-600">Shipping</span>
            <span id="order-shipping" class="font-medium">₹40</span>
          </div>
          
          <div class="flex justify-between text-lg font-bold pt-2">
            <span>Total</span>
            <span id="order-total" class="text-green-700">₹0</span>
          </div>
        </div>
        
        <h3 class="text-lg font-bold text-green-800 mt-8 mb-4">Payment Method</h3>
        
        <div class="space-y-3">
          <div>
            <input type="radio" id="cod" name="payment" value="cod" checked class="hidden">
            <label for="cod" class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-green-500">
              <span class="w-5 h-5 rounded-full border-2 border-green-500 flex items-center justify-center mr-3">
                <span class="w-3 h-3 rounded-full bg-green-500 hidden"></span>
              </span>
              <span class="text-green-600 mr-3"><i class="fas fa-money-bill-wave"></i></span>
              <span>Cash on Delivery</span>
            </label>
          </div>
          
          <div>
            <input type="radio" id="online" name="payment" value="online" class="hidden">
            <label for="online" class="flex items-center p-4 border border-gray-300 rounded-lg cursor-pointer hover:border-green-500">
              <span class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3">
                <span class="w-3 h-3 rounded-full bg-green-500 hidden"></span>
              </span>
              <span class="text-green-600 mr-3"><i class="fas fa-credit-card"></i></span>
              <span>Online Payment</span>
            </label>
          </div>
        </div>
        
        <button id="place-order-btn" class="w-full mt-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white font-bold rounded-lg shadow-md hover:from-green-700 hover:to-green-800 transition-all">
          <i class="fas fa-shopping-bag mr-2"></i> Place Order
        </button>
        
        <a href="cart.html" class="block mt-4 text-center text-green-600 hover:text-green-800 font-medium">
          <i class="fas fa-arrow-left mr-1"></i> Back to Cart
        </a>
      </section>
    </div>
  </main>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center">
    <i class="fas fa-check-circle mr-2"></i>
    <span id="toast-message">Order placed successfully!</span>
  </div>

  <script>
    const API_BASE_URL = "https://brahminfoods-website-production.up.railway.app";
    const cart = JSON.parse(localStorage.getItem("brahminFoodsCart")) || [];
    const placeOrderBtn = document.getElementById('place-order-btn');
    const deliveryType = document.getElementById('delivery-type');
    const courierFields = document.getElementById('courier-fields');
    const toast = document.getElementById('toast');

    // Format currency
    const formatCurrency = (amount) => {
      return '₹' + amount.toLocaleString('en-IN');
    };

    // Show toast notification
    const showToast = (message, isError = false) => {
      toast.className = isError 
        ? 'fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center'
        : 'fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-lg shadow-xl flex items-center';
      
      document.getElementById('toast-message').textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    };

    // Render order summary
    const renderOrderSummary = () => {
      const orderItemsContainer = document.getElementById('order-items');

      if (cart.length === 0) {
        orderItemsContainer.innerHTML = `
          <div class="text-center py-6 text-gray-500">
            <i class="fas fa-shopping-cart text-3xl mb-2"></i>
            <p>Your cart is empty</p>
          </div>
        `;
        return;
      }

      // Combine duplicate items
      const combinedCart = cart.reduce((acc, item) => {
        const existingItem = acc.find(i => i.id === item.id);
        if (existingItem) {
          existingItem.quantity += item.quantity || 1;
        } else {
          acc.push({...item, quantity: item.quantity || 1});
        }
        return acc;
      }, []);

      orderItemsContainer.innerHTML = combinedCart.map(item => `
        <div class="flex justify-between items-center py-2 border-b border-gray-100">
          <div>
            <span class="font-medium">${item.name?.en || item.name}</span>
            <span class="text-gray-500 text-sm block">${item.weight} • ${item.quantity}x</span>
          </div>
          <span class="font-medium">${formatCurrency(item.price * item.quantity)}</span>
        </div>
      `).join('');

      const subtotal = combinedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const shipping = deliveryType.value === 'guntur' ? 40 : 0; // Courier shipping calculated separately
      const total = subtotal + shipping;

      document.getElementById('order-subtotal').textContent = formatCurrency(subtotal);
      document.getElementById('order-shipping').textContent = formatCurrency(shipping);
      document.getElementById('order-total').textContent = formatCurrency(total);
    };

    // Toggle courier fields
    deliveryType.addEventListener('change', () => {
      if (deliveryType.value === 'courier') {
        courierFields.classList.remove('hidden');
        document.getElementById('order-shipping').textContent = 'Calculated separately';
      } else {
        courierFields.classList.add('hidden');
        renderOrderSummary();
      }
    });

    // Custom radio button styling
    document.querySelectorAll('input[name="payment"]').forEach(radio => {
      radio.addEventListener('change', () => {
        document.querySelectorAll('input[name="payment"] + label').forEach(label => {
          label.querySelector('span:first-child').classList.replace('border-green-500', 'border-gray-300');
          label.querySelector('span:first-child > span').classList.add('hidden');
        });
        
        const selectedLabel = document.querySelector(`input[name="payment"]:checked + label`);
        selectedLabel.querySelector('span:first-child').classList.replace('border-gray-300', 'border-green-500');
        selectedLabel.querySelector('span:first-child > span').classList.remove('hidden');
      });
    });

    // Place order
    placeOrderBtn.addEventListener('click', async () => {
      const form = document.getElementById('delivery-form');
      
      // Validate form
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // Validate courier agreement if needed
      if (deliveryType.value === 'courier' && !document.getElementById('agree-courier').checked) {
        showToast('Please agree to courier charges', true);
        return;
      }

      // Combine duplicate items
      const combinedCart = cart.reduce((acc, item) => {
        const existingItem = acc.find(i => i.id === item.id);
        if (existingItem) {
          existingItem.quantity += item.quantity || 1;
        } else {
          acc.push({...item, quantity: item.quantity || 1});
        }
        return acc;
      }, []);

      // Prepare order data
      const orderData = {
        items: combinedCart,
        subtotal: combinedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
        shipping: deliveryType.value === 'guntur' ? 40 : 0,
        total: combinedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0) + 
               (deliveryType.value === 'guntur' ? 40 : 0),
        customerInfo: {
          name: document.getElementById('full-name').value,
          phone: document.getElementById('phone').value,
          address: {
            street: document.getElementById('address').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            pincode: document.getElementById('pincode').value,
            landmark: document.getElementById('landmark').value || undefined
          }
        },
        paymentMethod: document.querySelector('input[name="payment"]:checked').value,
        deliveryType: deliveryType.value,
        courierPreference: deliveryType.value === 'courier' 
          ? document.getElementById('courier-preference').value || undefined 
          : undefined
      };

      // Set loading state
      placeOrderBtn.disabled = true;
      placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';

      try {
        const response = await fetch(`${API_BASE_URL}/api/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Failed to place order');
        }

        const data = await response.json();
        
        // Show success
        showToast('Order placed successfully!');
        
        // Clear cart and redirect
        localStorage.removeItem('brahminFoodsCart');
        setTimeout(() => {
          window.location.href = `order_confirmation.html?orderId=${data.orderId}`;
        }, 1500);
      } catch (error) {
        console.error('Order error:', error);
        showToast(error.message || 'Failed to place order. Please try again.', true);
        placeOrderBtn.disabled = false;
        placeOrderBtn.innerHTML = '<i class="fas fa-shopping-bag mr-2"></i> Place Order';
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      renderOrderSummary();
      
      // If cart is empty, redirect after delay
      if (cart.length === 0) {
        showToast('Your cart is empty. Redirecting...', true);
        setTimeout(() => {
          window.location.href = 'menu.html';
        }, 2000);
      }
      
      // Initialize radio buttons
      document.querySelector('input[name="payment"]:checked').dispatchEvent(new Event('change'));
    });
  </script>
</body>
</html>